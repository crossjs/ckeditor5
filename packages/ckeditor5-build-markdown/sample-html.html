<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>CKMD - HTML</title>
	<style>
		body {
			margin: 0;
		}
		header {
			display: flex;
			margin: 20px;
			gap: 20px;
			align-items: center;
		}
		header > input {
			margin-right: -10px;
		}
		main {
			display: flex;
			margin: 20px;
			gap: 20px;
			position: relative;
		}
		main > section:nth-child(1) {
			flex: 5.5;
		}
		main > section:nth-child(2) {
			flex: 1.5 1.5 15%;
			padding: 0 10px;
			box-shadow: inset 0 0 0 1px hsl(0, 0%, 80%);
		}
		main > section:nth-child(3) {
			flex: 1.5 1.5 15%;
			padding: 0 10px;
			box-shadow: inset 0 0 0 1px hsl(0, 0%, 80%);
		}
		main > section:nth-child(4) {
			flex: 1.5 1.5 15%;
			padding: 0 10px;
			box-shadow: inset 0 0 0 1px hsl(0, 0%, 80%);
		}
		main > section.collapsed {
			position: absolute;
			visibility: hidden;
			z-index: -1;
		}
		textarea#editor {
			position: absolute;
			visibility: hidden;
			z-index: -1;
		}
		pre {
			white-space: pre-wrap;
			word-break: break-word;
		}
		#preview li > p {
			margin: 0;
		}
	</style>
</head>
<body>

<header>
	<input id="toggle-2" aria-label="toggle" type="checkbox" /> <label for="toggle-2">markdown</label>
	<input id="toggle-3" aria-label="toggle" type="checkbox" /> <label for="toggle-3">html</label>
	<input id="toggle-4" aria-label="toggle" type="checkbox" /> <label for="toggle-4">preview</label>
</header>

<main>
	<section>
		<textarea id="editor"><ol><li>Soyuz (Soviet/Russian)<ol><li>Early stage (all retired)<ul><li>7K-OK</li><li>7KT-OK</li><li>7K-T</li><li>7K-TM</li></ul></li><li>Soyuz T (retired)</li><li>Soyuz TM (retired)</li><li>Soyuz TMA (retired)</li><li>Soyuz TMA-M (retired)</li><li>Soyuz MS</li></ol></li><li>STS orbiter (American; all retired)<ul><li>Columbia</li><li>Challenger</li><li>Discovery</li><li>Atlantis</li><li>Endeavour</li></ul></li><li>SpaceX Crew Dragon (American)</li><li>Shenzhou (Chinese)</li></ol></textarea>
	</section>

	<section class="collapsed">
		<pre><code class="container"></code></pre>
	</section>

	<section class="collapsed">
		<pre><code class="container"></code></pre>
	</section>

	<section class="collapsed">
		<div class="container"></div>
	</section>
</main>

<script src="./build/ckmd.js"></script>
<script src="./build/translations/zh-cn.js"></script>
<script>
	function UploadAdapterPlugin(editor) {
		editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
			return {
				upload() {
					return loader.file.then(async (file) => {
						// loader.uploaded = false;
						await new Promise((resolve) => {
							setTimeout(resolve, 3000);
						});
						// loader.uploaded = true;
						return { default: URL.createObjectURL(file), source: null };
					});
				},
				abort() {},
			};
		};
	}


	function handleEditor(editor) {
		window.editor = editor;

		const e2 = document.querySelector('main > :nth-child(2)');
		const e3 = document.querySelector('main > :nth-child(3)');
		const e4 = document.querySelector('main > :nth-child(4)');

		const callback = () => {
			const data = editor.getData();

			if (!e2.classList.contains('collapsed')) e2.querySelector('.container').textContent = CKMD.html2markdown(data);
			if (!e3.classList.contains('collapsed')) e3.querySelector('.container').textContent = data;
			if (!e4.classList.contains('collapsed')) e4.querySelector('.container').innerHTML = data;
		}

		editor.model.document.on('change:data', callback);

		setTimeout(callback, 500);
	}

	CKMD.create( document.querySelector('#editor'), {
		language: 'zh-cn',
		removePlugins: ['Markdown'],
		extraPlugins: [
			UploadAdapterPlugin,
		],
	} )
	.then(handleEditor)
	.catch((error) => {
		console.error( 'There was a problem initializing the editor.', error );
	});

	function handleToggle(index) {
		const checkbox = document.querySelector('#toggle-' + index);

		checkbox.addEventListener('change', (e) => {
			const el = document.querySelector('main > section:nth-child(' + index + ')');

			if (!e.target.checked) {
				el.classList.add('collapsed')
				localStorage.setItem('collapsed' + index, '1')
			} else {
				el.classList.remove('collapsed')
				localStorage.removeItem('collapsed' + index)
			}

		});

		checkbox.checked = !(localStorage.getItem('collapsed' + index));

		const event = document.createEvent("HTMLEvents");
		event.initEvent('change', false, true);
		checkbox.dispatchEvent(event);
	}

	[2, 3, 4].forEach(handleToggle);
</script>

</body>
</html>
